from flask import Flask, request, jsonify, render_template_string

app = Flask(__name__)

# Basit HTML formu
html_form = """
<!DOCTYPE html>
<html>
<head><title>EV Şarj İstasyonu Ödeme</title></head>
<body>
  <h2>Şarj İstasyonu Ödemesi</h2>
  <form method="POST" action="/pay">
    Kart Numarası: <input type="text" name="card_number"><br><br>
    Tutar (₺): <input type="number" name="amount"><br><br>
    <button type="submit">Ödeme Yap</button>
  </form>
</body>
</html>
"""

@app.route("/")
def home():
    return render_template_string(html_form)

@app.route("/pay", methods=["POST"])
def pay():
    card_number = request.form.get("card_number")
    amount = request.form.get("amount")

    # Basit anomali: belirli kart numaralarını “şüpheli” olarak işaretleyelim
    if card_number.endswith("4242"):
        anomaly = True
        message = "⚠️ Anomali: Kart bilgisi şüpheli bir istekte kullanıldı!"
        # Burada verileri bir 'log' dosyasına yazıyormuş gibi simüle ediyoruz
        with open("anomaly_log.txt", "a") as f:
            f.write(f"Anomali tespit edildi! Kart: {card_number}, Tutar: {amount}\n")
    else:
        anomaly = False
        message = "✅ Ödeme başarıyla işlendi."

    return jsonify({
        "card_number": card_number,
        "amount": amount,
        "anomaly_detected": anomaly,
        "message": message
    })

if __name__ == "__main__":
    app.run(debug=True, host="0.0.0.0")